%-- help for custom database get_Clinic_Data.m---
%
%Function provides you with an interface to the BGL Data
%
%The function will return a double array that has one row per BGL Sample
%
%Column 1           Column 2    
%Time of sample     Value of sample
%
%Function arguments are:
%   studySessionID  - a number value that represents the study session %that you wish to view data for
function[data] = get_Clinic_Data(studySessionID, TableName)
    
    studySessionID = num2str(studySessionID);
    patientIndex = num2str(get_PatientIndex(studySessionID));
    conn = DB_Connection;

    if(isconnection(conn))
        
        %import sql script
        valuesSQLscript = strcat(TableName, 'Values.txt');
        timeSQLscript = strcat(TableName, 'Time.txt');
        
        sqlStr_value = textread(valuesSQLscript,'%s', 'whitespace', '');
        sqlStr_Time = textread(timeSQLscript,'%s', 'whitespace', '');
        
        sqlStr_value = strrep(sqlStr_value, '#StudySessionID', studySessionID);
        sqlStr_Time = strrep(sqlStr_Time, '#StudySessionID', studySessionID);
        
        sqlStr_value = strrep(sqlStr_value, '#PatientIndex', patientIndex);
        sqlStr_Time = strrep(sqlStr_Time, '#PatientIndex', patientIndex);
        
        
        sqlStr_value = cell2mat(sqlStr_value);
        sqlStr_Time = cell2mat(sqlStr_Time);
        
        %Get the BGL Value from the databse
        curs  = exec(conn,sqlStr_value);
        c = fetch(curs);
        data_Value = c.Data;       
        
        clear('curs', 'c');
        
        curs  = exec(conn,sqlStr_Time);
        c = fetch(curs);
        data_Time = c.Data;
        if strcmp(TableName,'ALL_Calibration_BGL') | strcmp(TableName,'HypoAlarmBGL')
            a = find(strcmp(cellstr(data_Time),'null'));
            if ~isempty(a)
                n = length(a)/2;
                for i = 1:n
                    data_Time(a(i),1) = {'00/00/0000'};
                    data_Time(a(i),2) = {'00:00:00 +00:00'};
                end
            end
            data_Time = cell2mat(data_Time);
                
        else
            data_Time = cell2mat(data_Time);
        end
        clear ('sqlStr_value', 'sqlStr_Time', 'curs','c');
        
        array_size = size(data_Time);
        value_arraySize = size(data_Value);
        
        clear data
        data_Value(1,1);
        if(strcmp(data_Value(1,1), 'No Data'))
            data = cell2mat(data_Value);
            data = strcat(data,' Found In Database');
        else
            for i = 1:array_size(1)
                
                DD = str2num(strcat(data_Time(i,1),data_Time(i,2)));
                MM = str2num(strcat(data_Time(i,4),data_Time(i,5)));
                YYYY = str2num(strcat(data_Time(i,7),data_Time(i,8),data_Time(i,9),data_Time(i,10)));
                
                hh = str2num(strcat(data_Time(i,11),data_Time(i,12)));
                mm = str2num(strcat(data_Time(i,14),data_Time(i,15)));
                ss = str2num(strcat(data_Time(i,17),data_Time(i,18)));
                
                data(i,1) = datenum(YYYY,MM,DD,hh,mm,ss);
                
                j = 2;            
                while(j<=value_arraySize(2)+1)
                    data(i,j) = cell2mat(data_Value(i,j-1));
                    j = j +1;
                end
                clear DD MM YYYY hh mm ss
                
            end
        end
        
    end
    
    clear('conn', 'data_Time', 'data_Value', 'array_size', 'value_arraySize');
